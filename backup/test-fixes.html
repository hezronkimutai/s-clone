<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz App - Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .warning { border-left-color: #ffc107; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Quiz App Debug Test</h1>
    
    <div class="test-section">
        <h3>Firebase Connection Test</h3>
        <button onclick="testFirebaseConnection()">Test Firebase</button>
        <div id="firebase-result"></div>
    </div>
    
    <div class="test-section">
        <h3>Questions Loading Test</h3>
        <button onclick="testQuestionsLoading()">Load Questions</button>
        <div id="questions-result"></div>
    </div>
    
    <div class="test-section">
        <h3>Session Creation Test</h3>
        <button onclick="testSessionCreation()">Create Test Session</button>
        <div id="session-result"></div>
    </div>
    
    <div class="test-section">
        <h3>Debug Console</h3>
        <div id="debug-console"></div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA2MOailKWC3twyYL9zgEvLV81HvCuobW0",
            authDomain: "hkgroup-5e357.firebaseapp.com",
            databaseURL: "https://hkgroup-5e357-default-rtdb.firebaseio.com",
            projectId: "hkgroup-5e357",
            storageBucket: "hkgroup-5e357.firebasestorage.app",
            messagingSenderId: "666174502563",
            appId: "1:666174502563:web:347281452bf18b4e697116",
            measurementId: "G-5BVC79DJYQ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let questions = [];
        
        // Default questions
        const defaultQuestions = [
            {
                question: "Which factor has the biggest impact on milk shelf life?",
                options: ["Temperature control", "Packaging material", "Storage humidity", "Cow's mood"],
                correct: 0
            },
            {
                question: "If we designed a \"Milk-as-a-Service\" platform, what's the hardest problem to solve?",
                options: ["Subscription billing", "Cold-chain logistics", "API uptime", "Preventing milk from spoiling"],
                correct: 3
            }
        ];
        
        function log(message, type = 'info') {
            const console_div = document.getElementById('debug-console');
            const timestamp = new Date().toLocaleTimeString();
            console_div.innerHTML += `<div style="color: ${type === 'error' ? 'red' : type === 'success' ? 'green' : 'black'};">[${timestamp}] ${message}</div>`;
            console_div.scrollTop = console_div.scrollHeight;
            console.log(message);
        }
        
        function testFirebaseConnection() {
            log('Testing Firebase connection...');
            const result_div = document.getElementById('firebase-result');
            
            database.ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    result_div.innerHTML = '<div class="success">✅ Firebase Connected Successfully</div>';
                    log('Firebase connection successful', 'success');
                } else {
                    result_div.innerHTML = '<div class="error">❌ Firebase Not Connected</div>';
                    log('Firebase connection failed', 'error');
                }
            });
            
            // Test basic write/read
            const testRef = database.ref('test');
            testRef.set({ timestamp: Date.now() }).then(() => {
                log('Firebase write test successful', 'success');
                return testRef.once('value');
            }).then((snapshot) => {
                log('Firebase read test successful: ' + JSON.stringify(snapshot.val()), 'success');
            }).catch((error) => {
                log('Firebase test error: ' + error.message, 'error');
            });
        }
        
        function testQuestionsLoading() {
            log('Testing questions loading...');
            const result_div = document.getElementById('questions-result');
            
            database.ref('questions').once('value').then(snapshot => {
                const firebaseQuestions = snapshot.val();
                log('Firebase questions data: ' + JSON.stringify(firebaseQuestions));
                
                if (firebaseQuestions) {
                    questions = Object.values(firebaseQuestions);
                    result_div.innerHTML = `<div class="success">✅ Loaded ${questions.length} questions from Firebase</div>`;
                    log(`Loaded ${questions.length} questions from Firebase`, 'success');
                } else {
                    questions = [...defaultQuestions];
                    result_div.innerHTML = `<div class="warning">⚠️ No Firebase questions, using ${questions.length} defaults</div>`;
                    log(`Using ${questions.length} default questions`, 'warning');
                }
                
                result_div.innerHTML += '<pre>' + JSON.stringify(questions, null, 2) + '</pre>';
            }).catch(error => {
                questions = [...defaultQuestions];
                result_div.innerHTML = `<div class="error">❌ Error loading questions: ${error.message}</div>`;
                log('Error loading questions: ' + error.message, 'error');
            });
        }
        
        function testSessionCreation() {
            if (questions.length === 0) {
                log('Loading questions first...');
                testQuestionsLoading();
                setTimeout(testSessionCreation, 2000);
                return;
            }
            
            log('Testing session creation...');
            const result_div = document.getElementById('session-result');
            const sessionCode = 'TEST' + Math.random().toString(36).substring(2, 6).toUpperCase();
            
            database.ref('sessions/' + sessionCode).set({
                host: 'Test Host',
                status: 'waiting',
                currentQuestion: -1,
                participants: {},
                questions: questions,
                questionsArray: questions,
                totalQuestions: questions.length,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                result_div.innerHTML = `<div class="success">✅ Session created successfully: ${sessionCode}</div>`;
                log(`Session ${sessionCode} created successfully`, 'success');
                
                // Test reading the session back
                return database.ref('sessions/' + sessionCode).once('value');
            }).then(snapshot => {
                const session = snapshot.val();
                log('Session data verification: ' + JSON.stringify(session, null, 2));
                result_div.innerHTML += '<pre>' + JSON.stringify(session, null, 2) + '</pre>';
            }).catch(error => {
                result_div.innerHTML = `<div class="error">❌ Session creation failed: ${error.message}</div>`;
                log('Session creation error: ' + error.message, 'error');
            });
        }
        
        // Auto-test on load
        window.onload = function() {
            log('Debug test page loaded');
            setTimeout(testFirebaseConnection, 1000);
        };
    </script>
</body>
</html>
